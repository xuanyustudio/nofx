# 代理配置说明

## 问题说明

由于网络限制，程序在以下三个地方连接币安时可能会被墙：

1. **HTTP API 请求** - 连接 `https://fapi.binance.com` 获取市场数据
2. **WebSocket 连接** - 连接 `wss://ws-fapi.binance.com` 接收实时行情
3. **币安交易客户端** - 使用币安SDK进行交易操作

## 解决方案

程序已添加完整的代理支持，可以通过配置文件设置代理。

## 配置步骤

### 方法 1: 通过配置文件（推荐）

1. **编辑 `config.json` 文件**，添加 `proxy_url` 配置项：

```json
{
  "admin_mode": true,
  "beta_mode": false,
  "leverage": {
    "btc_eth_leverage": 5,
    "altcoin_leverage": 5
  },
  "use_default_coins": true,
  "default_coins": [
    "BTCUSDT",
    "ETHUSDT",
    "SOLUSDT"
  ],
  "api_server_port": 8080,
  "proxy_url": "http://127.0.0.1:7890",
  "log": {
    "level": "info"
  }
}
```

2. **代理地址格式**：
   - HTTP 代理: `http://127.0.0.1:7890`
   - HTTPS 代理: `https://127.0.0.1:7890`
   - SOCKS5 代理: `socks5://127.0.0.1:1080`

3. **保存配置文件并重启程序**

### 方法 2: 通过环境变量

如果您不想修改配置文件，也可以通过环境变量设置代理：

**Windows (PowerShell)**:
```powershell
$env:BINANCE_PROXY="http://127.0.0.1:7890"
.\nofx.exe
```

**Linux/MacOS**:
```bash
export BINANCE_PROXY="http://127.0.0.1:7890"
./nofx
```

**注意**: 环境变量方式只对币安交易客户端生效，市场数据和WebSocket仍需通过配置文件设置。

## 常见代理软件端口

- **Clash**: 默认 HTTP 端口 `7890`
- **V2Ray**: 默认 SOCKS5 端口 `1080`
- **SSR**: 默认端口 `1080`

## 验证代理配置

启动程序后，如果代理配置成功，您会看到以下日志：

```
✓ 已配置全局代理: http://127.0.0.1:7890
📡 市场数据API代理已设置: http://127.0.0.1:7890
  ✓ HTTP客户端使用代理: http://127.0.0.1:7890
  ✓ WebSocket使用代理: http://127.0.0.1:7890
📡 币安交易客户端使用代理: http://127.0.0.1:7890
```

## 代理生效范围

配置代理后，以下所有连接都会通过代理：

✅ 币安API市场数据查询
✅ 币安WebSocket实时行情
✅ 币安合约交易操作
✅ 币安账户信息查询
✅ 币安持仓信息查询

## 故障排除

### 1. 代理无法连接

**症状**: 程序启动后仍然无法连接币安

**解决方法**:
- 检查代理软件是否正常运行
- 确认代理端口号是否正确
- 尝试在浏览器中测试代理是否可用
- 检查防火墙是否阻止了本地代理连接

### 2. 代理地址格式错误

**症状**: 看到日志 `⚠️ 代理URL解析失败`

**解决方法**:
- 确保代理地址格式正确: `http://IP:端口`
- 不要遗漏 `http://` 前缀
- 端口号必须是数字

### 3. 代理配置未生效

**症状**: 没有看到代理相关日志

**解决方法**:
- 确认 `config.json` 中的 `proxy_url` 不是空字符串
- 确认配置文件已保存
- 重启程序

## 安全建议

1. **使用本地代理**: 建议使用 `127.0.0.1` 本地地址，不要使用公共代理
2. **保护配置文件**: `config.json` 包含敏感信息，请妥善保管
3. **代理软件选择**: 使用可信的代理软件（如 Clash、V2Ray）

## 示例配置

### Clash 用户

```json
{
  "proxy_url": "http://127.0.0.1:7890"
}
```

### V2Ray 用户

```json
{
  "proxy_url": "socks5://127.0.0.1:1080"
}
```

### 自定义代理

```json
{
  "proxy_url": "http://your-proxy-ip:your-proxy-port"
}
```

## 禁用代理

如果需要禁用代理，将 `proxy_url` 设置为空字符串：

```json
{
  "proxy_url": ""
}
```

---

如有问题，请检查日志输出或联系技术支持。

